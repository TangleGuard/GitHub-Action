name: "TangleGuard"
description: "Abstracts your codebase into an interactive dependency graph diagram for architectural analysis."
author: "Jan Arends"
inputs:
  upload_results:
    description: "To upload the scan result to TangleGuard Cloud for further analysis"
    required: false
    default: "false"
  repository:
    description: "Repository in format 'owner/project' (optional, will be extracted from Git if not provided)"
    required: false
  description:
    description: "Project description for TangleGuard Cloud"
    required: false
  language:
    description: "Programming language (rust|javascript)"
    required: true
  path:
    description: "Path to the workspace to analyze (defaults to current directory)"
    required: false
    default: "."
  ignore_paths:
    description: "Comma-separated list of directory names to ignore during scanning (e.g., 'examples,benchmarks')"
    required: false
  fail_on_findings:
    description: "Whether to fail the action if any findings are detected"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Validate input parameters
      shell: bash
      run: |
        echo "üîç Validating input parameters..."

        # Description is required when uploading results
        if [[ "${{ inputs.upload_results }}" == "true" && -z "${{ inputs.description }}" ]]; then
          echo "‚ùå Error: description is required when upload_results is enabled."
          echo "   Please provide a project description for better identification on the website."
          exit 1
        fi

        echo "‚úÖ Input validation passed"

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Download TangleGuard CLI
      shell: bash
      run: |
        echo "Downloading TangleGuard CLI..."
        if ! curl -L -o tangleguard-cli https://tangleguard-builds.s3.eu-central-1.amazonaws.com/cli/latest/tangleguard-cli; then
          echo "‚ùå Failed to download TangleGuard CLI"
          exit 1
        fi

        echo "Making it executable..."
        chmod +x tangleguard-cli

        echo "Verifying download..."
        if [[ ! -x "./tangleguard-cli" ]]; then
          echo "‚ùå TangleGuard CLI is not executable"
          exit 1
        fi
        echo "‚úÖ TangleGuard CLI downloaded"

    - name: Run TangleGuard validation
      shell: bash
      run: |
        echo "üîç Running TangleGuard validation..."

        validate_cmd="./tangleguard-cli -l ${{ inputs.language }} -p ${{ inputs.path }}"

        # Add ignore paths if specified
        if [[ -n "${{ inputs.ignore_paths }}" ]]; then
          validate_cmd="$validate_cmd --ignore-paths ${{ inputs.ignore_paths }}"
        fi

        validate_cmd="$validate_cmd validate"

        # Add --ci flag if fail_on_findings is true
        if [[ "${{ inputs.fail_on_findings }}" == "true" ]]; then
          validate_cmd="$validate_cmd --ci"
        fi

        echo "Running: $validate_cmd"
        eval $validate_cmd
        exit_code=$?

        if [[ $exit_code -eq 0 ]]; then
          echo "‚úÖ TangleGuard validation passed"
        else
          echo "‚ùå TangleGuard found architecture issues (exit code: $exit_code)"
          exit $exit_code
        fi

    - name: Upload results to TangleGuard Cloud
      shell: bash
      if: ${{ inputs.upload_results == 'true' }}
      run: |
        echo "Scanning workspace and uploading results to TangleGuard Cloud..."

        # Scan and upload results
        upload_cmd="./tangleguard-cli --language ${{ inputs.language }}"

        # Add path if specified (default is current directory)
        if [[ -n "${{ inputs.path }}" ]]; then
          upload_cmd="$upload_cmd --path ${{ inputs.path }}"
        fi

        # Add ignore paths if specified
        if [[ -n "${{ inputs.ignore_paths }}" ]]; then
          upload_cmd="$upload_cmd --ignore-paths ${{ inputs.ignore_paths }}"
        fi

        # Add upload subcommand
        upload_cmd="$upload_cmd upload"

        # Add upload subcommand arguments
        if [[ -n "${{ inputs.description }}" ]]; then
          upload_cmd="$upload_cmd --description \"${{ inputs.description }}\""
        fi

        if [[ -n "${{ inputs.repository }}" ]]; then
          upload_cmd="$upload_cmd --repository \"${{ inputs.repository }}\""
        fi

        eval $upload_cmd

branding:
  icon: "layers"
  color: "gray-dark"
